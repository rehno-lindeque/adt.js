/*
 * adt.js - Algebraic Data Types for JavaScript
 * adt.js is free, public domain software (http://creativecommons.org/publicdomain/zero/1.0/)
 * Originally created by Rehno Lindeque of http://www.mischievousmeerkat.com
 */
var adt = (function() {
"use strict";
var isADT=function(e){return Array.isArray(e)&&typeof e._tag=="string"},isInterface=function(e){return typeof e=="function"&&typeof e._eval=="function"},init=function(e,t){var n,r,i;for(n=0;n<t.length;++n){var s=t[n];if(Array.isArray(s))init(e,s);else if(typeof s=="string"||typeof s=="number"){if(s!=="_"&&String(s).charAt(0)==="_")continue;e[s]=function(e){return function(){return construct(e,arguments)}}(s)}else{if(typeof s!="object"&&typeof s!="function")continue;for(r in s){if(r!=="_"&&r.charAt(0)==="_")continue;typeof s[r]=="function"?e[r]=s[r]:e[r]=function(e){return function(){return e}}(s[r])}}}},adt=function(){var e={};return init(e,arguments),evaluators(e)},getObjectType=function(e){var t=Object.prototype.toString.call(e);return t.slice(t.indexOf(" ")+1,t.length-1)},getDataType=function(e){return isADT(e)?"ADT":getObjectType(e)},getTypeTag=function(e){return isADT(e)?e._tag:getObjectType(e)};adt.isADT=isADT,adt.isInterface=isInterface,adt.version="3.0.0";var construct=function(e,t){var n=[].slice.call(t,0);return n._tag=e,n},evaluators=function(e){var t,n=function(){return n._eval.apply(n,arguments)};typeof e["_"]=="undefined"&&(e._=function(){return this._datatype!=="ADT"?arguments[0]:construct(this._tag,arguments)},n._=function(){return e._.apply(n,arguments)});for(t in e)switch(t){case"eval":continue;default:t!=="eval"&&(typeof e[t]=="function"?n[t]=function(t){return function(){return e[t].apply(n,arguments)}}(t):n[t]=function(t){return function(){return e[t]}}(t))}var r=function(e,t,n){e[t]?e[t].push(n):e[t]=[n]},i,s={};for(i in n)switch(i){case"_eval":continue;default:var o=i.split(",").map(function(e){return e.split(" ").filter(function(e){return e!==""})});r(s,o.length,[i,o])}(function(){var e,t;for(e in s)t=s[e],t.sort(function(e,t){var n,r;for(n=0;n<e[1].length;++n){if(e[1][n].length!==t[1][n].length)return e[1][n].length>t[1][n].length?-1:1;for(r=0;r<e[1][n].length;++r){if(e[1][n][r]!=="_"&&t[1][n][r]==="_")return-1;if(e[1][n][r]==="_"&&t[1][n][r]!=="_")return 1;if(e[1][n][r]!=="ADT"&&t[1][n][r]==="ADT")return-1;if(e[1][n][r]==="ADT"&&t[1][n][r]!=="ADT")return 1}}return e[0]<t[0]?-1:1})})();var u=function(e,t){return e===getTypeTag(t)||e=="_"||isADT(t)&&e=="ADT"},a=function(e,t){var n;if(isADT(t)){if(e[0]=="_")return t.slice(0);if(e[0]!==t._tag)return null;if(e.length===1)return t.slice(0);for(n=0;n<t.length;++n)if(!u(e[n+1],t[n]))return null;return t.slice(0)}return e.length!==1||e[0]!==getObjectType(t)&&e[0]!=="_"?null:[t]},f=function(e,t){var n,r,i=[];for(n=0;n<e.length;++n){r=a(e[n],t[n]);if(r==null)return null;i=i.concat(r)}return{data:i,pattern:e.map(function(e){return e.join(" ")}).join(","),datatype:Array.prototype.map.call(t,getDataType).join(","),tag:Array.prototype.map.call(t,getTypeTag).join(",")}},l=function(){var e,t,r=s[arguments.length];if(r!=null)for(e=0;e<r.length;++e){t=f(r[e][1],arguments);if(t!=null)return t.eval=n[r[e][0]],t}return null};return n._eval=function(){var e,t=[],r=[],i=l.apply(void 0,arguments);if(i==null){n._pattern="_",n._tag=Array.prototype.map.call(arguments,getTypeTag).join(","),n._datatype=Array.prototype.map.call(arguments,getDataType).join(",");var s=Array.prototype.reduce.call(arguments,function(e,t){return e.concat(isADT(t)?t:[t])},[]);return n._.apply(n,s)}return n._pattern=i.pattern,n._tag=i.tag,n._datatype=i.datatype,i.eval.apply(n,i.data)},n};adt.constructors=function(e){var t,n=[];if(e!=null)for(t in e)n.push(t);return adt.apply(null,n)};var applyWith=function(e){return function(t){return e(t)}};adt.map=function(e,t){return t.map(applyWith(e))},adt.compose=function(){var e,t=arguments,n,r,i,s;if(t.length===0)return adt();n=typeof t[0]=="function"?t[0]:adt(t[0]);for(e=1;e<t.length;++e)r=typeof t[e]=="function"?t[e]:adt(t[e]),n=function(e,t){return function(){return e(t.apply(this,arguments))}}(r,n);s=[];for(e=0;e<t.length;++e)if(typeof t[e]=="object"||isInterface(t[e]))for(i in t[e])i.length>0&&i[0]!=="_"&&s.push(i);n._eval=n;for(e=0;e<s.length;++e)n[s[e]]=function(e,t){return function(){return e(construct.apply(null,[t].concat(arguments)))}}(n,s[e]);return n},adt.recursive=function(e){if(typeof e!="function")throw"Expected a function or ADT interface in adt.recursive";var t=isInterface(e)?e:adt({_:e}),n=function(e){var r,i=[],s;if(!isADT(e))return t(e);for(r=0;r<e.length;++r)s=n(e[r]),i.push(s);return t(construct(e._tag,i))};for(var r in t)n[r]=t[r];return n},adt.own=function(){var e,t,n,r,i,s={};for(e=0;e<arguments.length;++e){n=arguments[e],r=Object.getOwnPropertyNames(n);for(t=0;t<r.length;++t)i=r[t],s[i]=n[i]}return adt(s)},adt.own.constructors=function(e){var t,n=[];for(t=0;t<arguments.length;++t)n.push(Object.getOwnPropertyNames(arguments[t]));return adt.apply(null,Array.prototype.concat.apply([],n))},adt.serialize=function(e){var t=function(e,t){var n,r="",i,t=t||{"\0":"\\0","\b":"\\b","\f":"\\f","\n":"\\n","\r":"\\r","	":"\\t","":"\\v",'"':'\\"',"'":"\\'","\\":"\\\\"};for(n=0;n<e.length;++n)i=t[e[n]],r+=i==null?e[n]:i;return r},n={"\\":"\\\\",'"':'\\"',"'":"\\'","	":"\\t","\r":"\\r","\n":"\\n"," ":"\\ ",",":"\\,","(":"\\(",")":"\\)","[":"\\[","]":"\\]","{":"\\{","}":"\\}"},r=function(e,r){var i,o=t(e,n),u;for(i=0;i<r.length;++i)u=isADT(r[i])&&r[i].length>0,o+=" "+(u?"(":"")+s(r[i])+(u?")":"");return o},i=adt({Array:function(e){var t,n="[";if(e.length>0)for(t=0;;++t){n+=s(e[t]);if(t===e.length-1)break;n+=","}return n+="]",n},Object:function(e){var r,i=Object.keys(e),o="{";if(i.length>0)for(r=0;;++r){o+=t(i[r],n)+" = "+s(e[i[r]]);if(r===i.length-1)break;o+=","}return o+="}",o}}),s=adt({String:function(e){return this._datatype==="ADT"?r("String",arguments):'"'+e+'"'},Number:function(e){return this._datatype==="ADT"?r("Number",arguments):String(e)},Boolean:function(e){return this._datatype==="ADT"?r("Boolean",arguments):e?"True":"False"},Array:function(e){return this._datatype==="ADT"?r("Array",arguments):i(e)},Arguments:function(e){return this._datatype==="ADT"?r("Arguments",arguments):this([].slice.call(e,0))},Object:function(e){return this._datatype==="ADT"?r("Object",arguments):i(e)},_:function(){if(this._datatype!=="ADT")throw"Unsupported JavaScript built-in type `"+this._datatype+"` in `adt.serialize`.";return r(this._tag,arguments)}});return s(e)};var unescapeString=function(e){var t,n="",r={a:"",b:"\b",f:"\f",n:"\n",r:"\r",t:"	",v:"",'"':'"',"&":"","'":"'","\\":"\\"};for(t=0;t<e.length-1;++t)if(e[t]!=="\\")n+=e[t];else{var i=e[t+1],s=r[i],o=null,u=null;if(s!=null){n+=s,++t;continue}i>="0"&&i<="9"?(o=/[0-9]*/.exec(e.slice(t+1))[0],u=10):i=="x"?(o=/[0-9a-f]*/i.exec(e.slice(t+2))[0],u=16):i=="o"&&(o=/[0-7]*/.exec(e.slice(t+2))[0],u=8);if(o!=null&&o.length>0){var a=0,f;for(f=0;f<o.length;++f)a*=u,a+=parseInt(o[f],u);n+=String.fromCharCode(a),t+=o.length+(i=="x"||i=="o"?1:0);continue}n+=e[t+1],++t}return t===e.length-1?n+e[e.length-1]:n},eatWhiteSpace=function(e){for(var t=0;t<e.length;++t){switch(e[t]){case" ":case"\n":case"\r":case"	":continue}return e.slice(t)}return""},lexString=function(e){var t,n=1;for(;;){n=e.indexOf(e[0],n);if(n===-1)throw"No closing quotation mark was found for the string starting with "+e.slice(0,Math.min(5,e.length))+"...";for(t=n-1;t>=0;--t)if(e[t]!=="\\"){if(n-t&!0)return{head:e.slice(0,n+1),tail:e.slice(n+1)};break}n+=1}},lex=function(e){var t,n=1;e=eatWhiteSpace(e);if(e.length===0)return["",""];switch(e[0]){case"(":case")":case"[":case"]":case"{":case"}":case"=":case",":return{head:e[0],tail:e.slice(1)};case'"':case"'":return lexString(e);case"\\":n=2}for(var r=n;r<e.length;++r)switch(e[r]){case"(":case")":case"[":case"]":case"{":case"}":case"=":case",":case" ":case"\n":case"\r":case"	":return{head:e.slice(0,r),tail:e.slice(r)};case'"':case"'":throw"Illegal quote character `"+e[r]+"` found in lexeme. Quotes should be escaped using `\\"+e[r]+"`.";case"\\":if(r===e.length-1)throw"Escape character `\\` found at the end of the input string, followed by nothing.";++r}return{head:e,tail:""}},parseADTTail=function(e,t){var n=unescapeString(e),r=t,i=[];while(r.length>0)switch(r[0]){case")":case"]":case"}":case",":return{result:construct(n,i),tail:r};default:var s=parseArgument(r);if(s==null)continue;i.push(s.result),r=s.tail}return{result:construct(n,i),tail:r}},parseArrayTail=function(e){if(e.length<2)throw"No data supplied after array opening bracket `[`.";var t=e,n=0,r=[];while(t.length>0)switch(t[0]){case")":case"}":throw"Invalid character `"+t[0]+"` found in the data.";case",":++n,n<r.length&&r.push(undefined),t=t.slice(1);continue;case"]":return{result:r,tail:t.slice(1)};default:if(n<r.length)throw"Expected `,` separator between array elements.";var i=parse(t);if(i==null)continue;r.push(i.result),t=i.tail}throw"Could not find the closing bracket for the array `["+e.slice(0,Math.max(e.length,4)).join("")+"...`"},parseRecordTail=function(e){if(e.length<2)throw"No data supplied after record opening curly bracket `{`.";var t=e,n=0,r={},i=null;while(t.length>0)switch(t[0]){case")":case"]":throw"Invalid character `"+t[0]+"` found in the data.";case",":++n,n<r.length&&r.push(undefined),t=t.slice(1);continue;case"}":return{result:r,tail:t.slice(1)};default:if(n<r.length)throw"Expected `,` separator between record elements.";var s=parseRecordKeyVal(t);if(s==null)continue;r[s.result[0]]=s.result[1],t=s.tail}throw"Could not find the closing curly bracket for the record `{"+e.slice(0,Math.max(e.length,4)).join("")+"...`"},parseRecordKeyVal=function(e){if(e.length<3)throw"Expected 'key = val' in record syntax.";var t=unescapeString(e[0]);if(e[1]!="=")throw"Expected 'key = val' in record syntax.";var n=parse(e.slice(2));return{result:[t,n.result],tail:n.tail}},parseParensTail=function(e){if(e.length<1)throw"No data after opening parenthesis.";var t=e[0],n=e.slice(1);if(t.length===0)return parseParensTail(n);switch(t){case"(":throw"Invalid double opening parentheses `((` found.";case")":throw"No data supplied after opening parenthesis `(`. The unit type, (), is not supported.";case"[":case"]":case"{":case"}":case",":case'"':case"'":throw"Invalid character `"+t+"` found after opening parenthesis."}var r=parseADTTail(t,n);if(r.tail.length===0||r.tail[0]!==")")throw"Could not find the closing parenthesis for the data `("+e.slice(0,Math.max(e.length,4)).join(" ")+"...`";return{result:r.result,tail:r.tail.slice(1)}},parsePrimitive=function(e,t){switch(e){case"(":return parseParensTail(t);case"[":return parseArrayTail(t);case"{":return parseRecordTail(t)}switch(e[0]){case'"':return{result:unescapeString(e.slice(1,e.length-1)),tail:t};case"'":return{result:unescapeString(e.slice(1,e.length-1)),tail:t}}var n=Number(e);return isNaN(n)?null:{result:n,tail:t}},parseArgument=function(e){if(e.length==0)return null;var t=e[0],n=e.slice(1);if(t.length===0)return parseArgument(n);var r=parsePrimitive(t,n);if(r!=null)return r;var i=unescapeString(t);return{result:construct(i,[]),tail:n}},parse=function(e){if(e.length==0)return null;var t=e[0],n=e.slice(1);if(t.length===0)return parse(n);var r=parsePrimitive(t,n);return r!=null?r:parseADTTail(t,n)};adt.deserialize=function(e){var t=[],n={head:"",tail:e},r=[];while(n.tail.length>0)n=lex(n.tail),t.push(n.head);while(t.length>0&&t[0].length==0)t=t.slice(1);if(t.length==0)return;if(t[0]==="("&&t[t.length-1]!==")")throw lexemesStr=t.join(" "),"Optional opening parenthesis used for the data "+lexemesStr.slice(0,Math.min(10,lexemesStr.length))+"... but could not find the closing parenthesis.";return parse(t).result};  // Export adt to a CommonJS module if exports is available
  if (typeof(exports) !== "undefined" && exports !== null)
    module.exports = adt;
  return adt;
})();

