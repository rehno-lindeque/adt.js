/*
 * adt.js - Algebraic Data Types for JavaScript
 * adt.js is free, public domain software (http://creativecommons.org/publicdomain/zero/1.0/)
 * Originally created by Rehno Lindeque of http://www.mischievousmeerkat.com
 */
var adt = (function() {
"use strict";
var isADT=function(a){return Array.isArray(a)&&typeof a._tag=="string"},isInterface=function(a){return typeof a=="function"&&typeof a._eval=="function"},init=function(a,b){var c,d,e;for(c=0;c<b.length;++c){var f=b[c];if(Array.isArray(f))init(a,f);else if(typeof f=="string"||typeof f=="number"){if(f!=="_"&&String(f).charAt(0)==="_")continue;a[f]=function(a){return function(){return construct(a,arguments)}}(f)}else{if(typeof f!="object"&&typeof f!="function")continue;for(d in f){if(d!=="_"&&d.charAt(0)==="_")continue;typeof f[d]=="function"?a[d]=f[d]:a[d]=function(a){return function(){return a}}(f[d])}}}},adt=function(){var a={};return init(a,arguments),evaluators(a)},getObjectType=function(a){var b=Object.prototype.toString.call(a);return b.slice(b.indexOf(" ")+1,b.length-1)},escapeString=function(a,b){var c,d="",e,b=b||{"\\":"\\\\",'"':'\\"',"'":"\\'","\t":"\\t","\r":"\\r","\n":"\\n"};for(c=0;c<a.length;++c)e=b[a[c]],d+=e==null?a[c]:e;return d},unescapeString=function(a){var b,c="",d={"\\":"\\",'"':'"',"'":"'",t:"\t",r:"\r",n:"\n"};for(b=0;b<a.length-1;++b)if(a[b]!=="\\")c+=a[b];else{var e=d[a[b+1]];c+=e==null?a[b+1]:e,++b}return b===a.length-1?c+a[a.length-1]:c},construct=function(a,b){var c=[].slice.call(b);return c._tag=a,c},evaluators=function(a){var b,c=function(){return c._eval.apply(c,arguments)},d=function(a,b,d,e){var f;c._pattern=a!=null?a:b!=null?b:d,c._tag=b!=null?b:d,c._datatype=d!=null?d:"ADT";var g=c[c._pattern];return typeof g!="function"&&(g=c._),g.apply(c,e)};c._eval=function(a){return isADT(a)?d(null,a._tag,"ADT",a):d(null,null,getObjectType(a),[a])};for(b in a)switch(b){case"eval":continue;default:b!=="eval"&&(typeof a[b]=="function"?c[b]=function(b){return function(){return a[b].apply(c,arguments)}}(b):c[b]=function(b){return function(){return a[b]}}(b))}return typeof a["_"]=="undefined"&&(a._=function(){return this._datatype!=="ADT"?arguments[0]:adt.construct.apply(null,[this._tag].concat([].slice.call(arguments,0)))},c._=function(){return a._.apply(c,arguments)}),c};adt.constructors=function(a){var b,c=[];if(a!=null)for(b in a)c.push(b);return adt.apply(null,c)},adt.compose=function(){var a,b=arguments,c,d,e,f;if(b.length===0)return adt();c=typeof b[0]=="function"?b[0]:adt(b[0]),f=[];for(a=1;a<b.length;++a){d=typeof b[a]=="function"?b[a]:adt(b[a]),c=function(a,b){return function(){return a(b.apply(this,arguments))}}(d,c);for(e in d)e.length>0&&e[0]!=="_"&&f.push(e)}c._eval=c;for(a=0;a<f.length;++a)c[f[a]]=function(a,b){return function(){return a(adt.construct.apply(null,[b].concat([].slice.call(arguments,0))))}}(c,f[a]);return c},adt.recursive=function(a){var b=function(c){var d,e=[],g;if(!isADT(c))return a(c);for(d=1;d<c.length;++d)g=b(c[d]),typeof g!="undefined"&&e.push(g);return a(construct(c[0],e))};for(var c in a)b[c]=a[c];return b},adt.own=function(){var a,b,c,d,e,f={};for(a=0;a<arguments.length;++a){c=arguments[a],d=Object.getOwnPropertyNames(c);for(b=0;b<d.length;++b)e=d[b],f[e]=c[e]}return adt(f)},adt.own.constructors=function(a){var b,c=[];for(b=0;b<arguments.length;++b)c.push(Object.getOwnPropertyNames(arguments[b]));return adt.apply(null,Array.prototype.concat.apply([],c))},adt.serialize=function(a){var b={"\\":"\\\\",'"':'\\"',"'":"\\'","\t":"\\t","\r":"\\r","\n":"\\n"," ":"\\ ",",":"\\,","(":"\\(",")":"\\)","[":"\\[","]":"\\]","{":"\\{","}":"\\}"},c=adt("SerializedADT").SerializedADT,d=adt({String:function(a){return c('"'+a+'"')},Number:function(a){return c(String(a))},Boolean:function(a){return c(a?"True":"False")},Array:function(a){return c("["+String(a)+"]")},Arguments:function(a){return this.Array([].slice.call(a,0))},Object:function(a){return c('"'+JSON.stringify(a)+'"')},SerializedADT:function(a){return c("("+a+")")},_:function(){if(this._datatype!=="ADT")throw"Unsupported primitive type `"+this._datatype+"` in `adt.serialize`.";var a,d=escapeString(this._tag,b);for(a=0;a<arguments.length;++a)d+=" "+this(arguments[a])[0];return c(d)}});return d(a)[0]};var eatWhiteSpace=function(a){for(var b=0;b<a.length;++b){switch(a[b]){case" ":case"\n":case"\r":case"\t":continue}return a.slice(b)}return""},lexString=function(a){var b,c=1;for(;;){c=a.indexOf(a[0],c);if(c===-1)throw"No closing quotation mark was found for the string starting with "+a.slice(0,Math.min(5,a.length))+"...";for(b=c-1;b>0;--b)if(a[b]!=="\\"){if(c-b&!0)return{head:a.slice(0,c+1),tail:a.slice(c+1)};break}}},lex=function(a){var b,c=1;a=eatWhiteSpace(a);if(a.length===0)return["",""];switch(a[0]){case"(":case")":case"[":case"]":case",":return{head:a[0],tail:a.slice(1)};case'"':case"'":return lexString(a);case"\\":c=2}for(var d=c;d<a.length;++d)switch(a[d]){case"(":case")":case"[":case"]":case",":case" ":case"\n":case"\r":case"\t":return{head:a.slice(0,d),tail:a.slice(d)};case'"':case"'":throw"Illegal quote character `"+a[d]+"` found in lexeme. Quotes should be escaped using `\\"+a[d]+"`.";case"\\":if(d===a.length-1)throw"Escape character `\\` found at the end of the input string, followed by nothing.";++d}return{head:a,tail:""}},parseADTTail=function(a){if(a.length<1)throw"No data supplied after opening parenthesis `(`.";var b=unescapeString(a[0]),c=a.slice(1),d=[];if(a.length>0&&a[0]==="(")throw"Invalid double opening parentheses `((` found.";while(c.length>0)switch(c[0]){case"]":case",":throw"Invalid character `"+c[0]+"` found in the data.";case")":return{result:construct(b,d),tail:c.slice(1)};default:var e=parse(c);if(e==null)continue;d.push(e.result),c=e.tail}throw"Could not find the closing parenthesis for the data `("+a.slice(0,Math.max(a.length,4)).join(" ")+"...`"},parseArrayTail=function(a){if(a.length<2)throw"No data supplied after array opening bracket `[`.";var b=a,c=0,d=[];while(b.length>0)switch(b[0]){case")":throw"Invalid character `"+b[0]+"` found in the data.";case",":++c,c<d.length&&d.push(undefined),b=b.slice(1);continue;case"]":return{result:d,tail:b.slice(1)};default:if(c<d.length)throw"Expected `,` separator between array elements.";var e=parse(b);if(e==null)continue;d.push(e.result),b=e.tail}throw"Could not find the closing bracket for the array `["+a.slice(0,Math.max(a.length,4)).join("")+"...`"},parse=function(a){var b=a[0],c=a.slice(1);if(b.length===0)return;switch(b){case"(":return parseADTTail(c);case"[":return parseArrayTail(c)}switch(b[0]){case'"':return{result:unescapeString(b.slice(1,b.length-1)),tail:c};case"'":return{result:unescapeString(b.slice(1,b.length-1)),tail:c}}var d=Number(b);if(!isNaN(d))return{result:d,tail:c};throw"Unexpected token `"+b+"` in data."};adt.deserialize=function(a){var b=[],c={head:"",tail:a},d=[];while(c.tail.length>0)c=lex(c.tail),b.push(c.head);while(b.length>0&&b[0].length==0)b=b.slice(1);if(b.length==0)return;if(b[0]==="("){if(b[b.length-1]!==")")throw lexemesStr=b.join(" "),"Optional opening parenthesis used for the data "+lexemesStr.slice(0,Math.min(10,lexemesStr.length))+"... but could not find the closing parenthesis."}else switch(b[0][0]){case'"':case"'":case"[":break;default:b=["("].concat(b).concat([")"])}return parse(b).result};  // Export adt to a CommonJS module if exports is available
  if (typeof(exports) !== "undefined" && exports !== null)
    exports.adt = adt;
  return adt;
})();

